import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from 'firebase/firestore';
import { getDatabase, ref, onValue, get } from 'firebase/database';

// Kredensial Firebase Anda yang dimasukkan secara langsung
const firebaseConfig = {
  apiKey: "AIzaSyCblBBI3macwNluj2Fv0QoHwHHuJKVtRec",
  authDomain: "divina-connect.firebaseapp.com",
  databaseURL: "https://divina-connect-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "divina-connect",
  storageBucket: "divina-connect.firebasestorage.app",
  messagingSenderId: "777570372540",
  appId: "1:777570372540:web:6b4f3be1b46dbe9fdcf9b9"
};

// Variabel global yang disediakan oleh lingkungan Canvas (hanya untuk auth token jika diperlukan)
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Inisialisasi Firebase di luar komponen untuk menghindari inisialisasi ulang
let app, db, auth, rtdb;

try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    rtdb = getDatabase(app);
} catch (error) {
    console.error("Gagal menginisialisasi Firebase:", error);
}

const Numpad = ({ onCodeEntered, promptText }) => {
    const [enteredCode, setEnteredCode] = useState("");

    const handleKeyClick = (key) => {
        if (key === 'del') {
            setEnteredCode(prev => prev.slice(0, -1));
        } else if (enteredCode.length < 4) {
            setEnteredCode(prev => prev + key);
        }
    };

    useEffect(() => {
        if (enteredCode.length === 4) {
            onCodeEntered(enteredCode);
        }
    }, [enteredCode, onCodeEntered]);

    return (
        <div id="numpad-overlay">
            <div id="numpad-container">
                <h2 id="numpad-prompt">{promptText}</h2>
                <div className="code-display">
                    {[0, 1, 2, 3].map(i => (
                        <span key={i} className="code-digit">
                            {enteredCode[i] || ""}
                        </span>
                    ))}
                </div>
                <div className="numpad" id="main-numpad">
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'del', 0].map(key => (
                        <button
                            key={key}
                            className="numpad-btn"
                            data-key={key}
                            onClick={() => handleKeyClick(key)}
                        >
                            {key === 'del' ? (
                                <svg viewBox="0 0 576 512"><path d="M576 128c0-35.3-28.7-64-64-64H205.3c-17 0-33.3 6.7-45.3 18.7L9.4 233.4c-6 6-9.4 14.1-9.4 22.6s3.4 16.6 9.4 22.6L160 429.3c12 12 28.3 18.7 45.3 18.7H512c35.3 0 64-28.7 64-64V128zM271 175c9.4-9.4 24.6-9.4 33.9 0l47 47 47-47c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-47-47-47 47c-9.4 9.4-24.6-9.4-33.9 0s-9.4-24.6 0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6 0-33.9z"/></svg>
                            ) : (
                                key
                            )}
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
};

const SettingsModal = ({ isVisible, onClose, onSave, initialChatId, initialPeekMode }) => {
    const [telegramChatId, setTelegramChatId] = useState(initialChatId || '');
    const [peekMode, setPeekMode] = useState(initialPeekMode || 'app');

    if (!isVisible) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex justify-center items-center z-[400]">
            <div className="bg-white p-8 rounded-2xl border border-gray-200 text-center shadow-lg w-11/12 max-w-md">
                <h2 className="font-serif text-2xl text-amber-900 mb-6">Pengaturan</h2>
                <div className="mb-6 text-left">
                    <label htmlFor="telegramChatId" className="block text-stone-700 text-sm font-bold mb-2">
                        ID Chat Telegram Anda:
                    </label>
                    <input
                        type="text"
                        id="telegramChatId"
                        className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        value={telegramChatId}
                        onChange={(e) => setTelegramChatId(e.target.value)}
                        placeholder="Masukkan ID Chat Telegram"
                    />
                    <p className="text-xs text-gray-500 mt-1">Dapatkan ID chat Anda dari @userinfobot di Telegram.</p>
                </div>
                <div className="mb-8 text-left">
                    <label className="block text-stone-700 text-sm font-bold mb-2">
                        Tampilkan Informasi Detail:
                    </label>
                    <div className="flex items-center mb-2">
                        <input
                            type="radio"
                            id="peekApp"
                            name="peekMode"
                            value="app"
                            checked={peekMode === 'app'}
                            onChange={(e) => setPeekMode(e.target.value)}
                            className="mr-2"
                        />
                        <label htmlFor="peekApp" className="text-gray-700">Di Aplikasi (Notifikasi)</label>
                    </div>
                    <div className="flex items-center">
                        <input
                            type="radio"
                            id="peekTelegram"
                            name="peekMode"
                            value="telegram"
                            checked={peekMode === 'telegram'}
                            onChange={(e) => setPeekMode(e.target.value)}
                            className="mr-2"
                        />
                        <label htmlFor="peekTelegram" className="text-gray-700">Di Telegram</label>
                    </div>
                </div>
                <div className="flex justify-end gap-4">
                    <button
                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                        onClick={onClose}
                    >
                        Batal
                    </button>
                    <button
                        className="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
                        onClick={() => onSave(telegramChatId, peekMode)}
                    >
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    );
};

const Toast = ({ message, type, onClose }) => {
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const textColor = 'text-white';

    useEffect(() => {
        const timer = setTimeout(() => {
            onClose();
        }, 3000); // Sembunyikan otomatis setelah 3 detik
        return () => clearTimeout(timer);
    }, [onClose]);

    return (
        <div className={`fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg ${bgColor} ${textColor} z-[500] animate-fade-in-up`}>
            {message}
        </div>
    );
};


const App = () => {
    const [enteredCode, setEnteredCode] = useState("");
    const [isConnected, setIsConnected] = useState(false);
    const [isTtsEnabled, setIsTtsEnabled] = useState(false);
    const [firebaseData, setFirebaseData] = useState(null);
    const [showNumpad, setShowNumpad] = useState(false);
    const [showLoading, setShowLoading] = useState(false);
    const [resultCode, setResultCode] = useState("");
    const [aiResult, setAiResult] = useState("");
    const [showSettingsModal, setShowSettingsModal] = useState(false);
    const [telegramChatId, setTelegramChatId] = useState(localStorage.getItem('telegramChatId') || '');
    const [peekMode, setPeekMode] = useState(localStorage.getItem('peekMode') || 'app');
    const [toast, setToast] = useState(null);
    const [showHoldOverlay, setShowHoldOverlay] = useState(false); // New state for peek overlay

    const holdTimeoutRef = useRef(null);
    const ttsTapCountRef = useRef(0);
    const ttsTapTimerRef = useRef(null);
    const userIdRef = useRef(null);

    // New state for two-finger swipe detection
    const touchStartPosRef = useRef([]); // Array of {x, y} for two touches
    const isSwipingRef = useRef(false);
    const swipeThreshold = 50; // pixels for swipe distance, reduced for better responsiveness

    const dynamicPrompts = [
        "masukan kombinasi angka random dalam hidupmu", "angka apa yang terlintas di benakmu saat ini?",
        "bisikan empat digit angka dari alam semesta...", "kombinasi mana yang memanggilmu hari ini?",
        "ungkap takdirmu melalui empat angka pilihan."
    ];

    const showToast = useCallback((message, type = 'info') => {
        setToast({ message, type });
    }, []);

    const closeToast = useCallback(() => {
        setToast(null);
    }, []);

    const cleanAIResponse = useCallback((responseText) => {
        const targetPhrase = "kombinasi ini";
        const lowercasedResponse = responseText.toLowerCase();
        const startIndex = lowercasedResponse.indexOf(targetPhrase);
        if (startIndex !== -1) {
            return responseText.substring(startIndex);
        }
        return responseText;
    }, []);

    const generateBarnumStatement = useCallback(async (code) => {
        const prompt = `Hasilkan satu kalimat saja yang menjelaskan makna kombinasi angka ${code} dari olahan barnum statement. JANGAN gunakan kata pembuka seperti "Tentu" atau "Berikut". Kalimat HARUS dimulai dengan "kombinasi ini..." dan merujuk pada pembaca dengan kata "kamu".`;
        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiKey = ""; // Kunci API disediakan oleh runtime Canvas jika kosong
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return cleanAIResponse(result.candidates[0].content.parts[0].text);
            }
            throw new Error("Format respons AI tidak valid.");
        } catch (error) {
            console.error("Kesalahan menghasilkan pernyataan Barnum:", error);
            throw error;
        }
    }, [cleanAIResponse]);

    const sendTelegramMessage = useCallback(async (chatId, data) => {
        if (!chatId) {
            showToast("ID Chat Telegram tidak ditemukan. Silakan atur di Pengaturan.", "error");
            return;
        }
        const botToken = "7639651359:AAF4XflfPvNvT6ku5APx3bSuzzbyG2cB_FY";
        const message = `*Informasi Angel Number:*\n\n*Bulan:* ${data.namaBulan}\n*Zodiak:* ${data.kemungkinanZodiak}\n*Pertanyaan:* ${data.pertanyaan}`;
        const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            if (!response.ok) {
                throw new Error(`Gagal mengirim ke Telegram.`);
            }
            showToast("Informasi berhasil dikirim ke Telegram!", "success");
        } catch (error) {
            console.error("Kesalahan saat mengirim ke Telegram:", error);
            showToast(error.message, "error");
        }
    }, [showToast]);

    const verifyAndConnect = useCallback(async (code) => {
        setShowLoading(true);
        setResultCode("");
        setAiResult("");
        setIsConnected(false);

        const roomRef = ref(rtdb, 'rooms/' + code);
        try {
            const snapshot = await get(roomRef);
            if (snapshot.exists() && snapshot.val().presence) {
                setIsConnected(true);
                
                // Selalu generate dan tampilkan ramalan
                const aiText = await generateBarnumStatement(code);
                setResultCode(code);
                setAiResult(aiText);
                
                const dataRef = ref(rtdb, 'rooms/' + code + '/data');
                onValue(dataRef, (dataSnapshot) => {
                    if (dataSnapshot.exists()) {
                        const { namaBulan, kemungkinanZodiak } = dataSnapshot.val();
                        let pertanyaan = "";
                        switch (namaBulan) {
                            case "Januari":   pertanyaan = "Q"; break; case "Februari":  pertanyaan = "A"; break;
                            case "Maret":     pertanyaan = "R"; break; case "April":     pertanyaan = "E"; break;
                            case "Mei":       pertanyaan = "U"; break; case "Juni":      pertanyaan = "G"; break;
                            case "Juli":      pertanyaan = "L"; break; case "Agustus":   pertanyaan = "V"; break;
                            case "September": pertanyaan = "B"; break; case "Oktober":   pertanyaan = "O"; break;
                            case "November":  pertanyaan = "T"; break; case "Desember":  pertanyaan = "S"; break;
                            default: pertanyaan = ""; break;
                        }
                        const currentFirebaseData = { namaBulan, kemungkinanZodiak, pertanyaan };
                        setFirebaseData(currentFirebaseData);

                        if (peekMode === 'telegram') {
                            sendTelegramMessage(telegramChatId, currentFirebaseData);
                        }
                        
                        if (isTtsEnabled) speak(`${namaBulan}. ${kemungkinanZodiak}. ${pertanyaan}.`);
                    }
                });

            } else {
                throw new Error(`Room ${code} tidak ditemukan atau tidak aktif.`);
            }
        } catch (error) {
            console.error("Koneksi gagal:", error);
            setIsConnected(false);
            setResultCode("Error");
            setAiResult("Sedang tidak bisa meramal saat ini, coba lagi.");
            setTimeout(() => {
                setShowNumpad(true);
            }, 3000);
        } finally {
            setShowLoading(false);
        }
    }, [generateBarnumStatement, isTtsEnabled, peekMode, sendTelegramMessage, telegramChatId, rtdb]);

    const speak = useCallback((text) => {
        if (!text || !isTtsEnabled) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'id-ID';
        window.speechSynthesis.speak(utterance);
    }, [isTtsEnabled]);

    const toggleTTS = useCallback(() => {
        setIsTtsEnabled(prev => {
            const newState = !prev;
            if (newState) {
                speak("Suara diaktifkan");
                if (firebaseData) {
                    speak(`${firebaseData.namaBulan}. ${firebaseData.kemungkinanZodiak}. ${firebaseData.pertanyaan}.`);
                }
            } else {
                window.speechSynthesis.cancel();
            }
            return newState;
        });
    }, [speak, firebaseData]);

    const handleTitleClick = useCallback(() => {
        if (isConnected) {
            window.location.reload();
        } else {
            setShowNumpad(true);
        }
    }, [isConnected]);

    const handleMainContainerClick = useCallback((e) => {
        // Jangan proses klik jika numpad, settings modal, atau hold overlay terbuka
        if (e.target.closest('#numpad-overlay') || e.target.closest('#settings-modal') || e.target.closest('#hold-overlay')) return;
        
        // Logika Triple Tap untuk TTS
        clearTimeout(ttsTapTimerRef.current);
        ttsTapCountRef.current++;
        ttsTapTimerRef.current = setTimeout(() => { ttsTapCountRef.current = 0; }, 600);
        if (ttsTapCountRef.current === 3) {
            ttsTapCountRef.current = 0;
            toggleTTS();
        }
    }, [toggleTTS]);

    const handleNumpadCodeEntered = useCallback((code) => {
        setEnteredCode(code);
        setShowNumpad(false);
        verifyAndConnect(code);
    }, [verifyAndConnect]);

    const handleSaveSettings = useCallback((chatId, mode) => {
        setTelegramChatId(chatId);
        setPeekMode(mode);
        // Menyimpan pengaturan di localStorage
        localStorage.setItem('telegramChatId', chatId);
        localStorage.setItem('peekMode', mode);
        setShowSettingsModal(false);
        showToast("Pengaturan disimpan!", "success");
    }, [showToast]);

    // Autentikasi dan Inisialisasi Firebase
    useEffect(() => {
        if (!app || !auth || !rtdb) {
            console.error("Firebase belum diinisialisasi sepenuhnya. Periksa konfigurasi.");
            return;
        }

        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (user) {
                userIdRef.current = user.uid;
                console.log("Firebase terautentikasi. ID Pengguna:", user.uid);
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase berhasil masuk.");
                } catch (error) {
                    console.error("Autentikasi Firebase gagal:", error);
                }
            }
        });

        return () => unsubscribe();
    }, [initialAuthToken]);

    // Logika Tekan dan Tahan untuk Peek Information
    const handleTapAndHoldStart = useCallback((e) => {
        // Hanya aktifkan jika 1 jari dan terhubung serta ada data Firebase
        // Atau jika ini adalah event mouse (klik dan tahan)
        if (isConnected && firebaseData && (e.touches === undefined || e.touches.length === 1)) {
            holdTimeoutRef.current = setTimeout(() => {
                setShowHoldOverlay(true);
            }, 500);
        }
    }, [isConnected, firebaseData]);

    const handleTapAndHoldEnd = useCallback(() => {
        clearTimeout(holdTimeoutRef.current);
        setShowHoldOverlay(false);
    }, []);

    // Logika Two-Finger Swipe Down untuk Settings Modal
    const handleTwoFingerTouchStart = useCallback((e) => {
        if (e.touches.length === 2) {
            touchStartPosRef.current = [
                { x: e.touches[0].clientX, y: e.touches[0].clientY },
                { x: e.touches[1].clientX, y: e.touches[1].clientY }
            ];
            isSwipingRef.current = false; // Reset swiping state
            // Penting: Mencegah default browser action (zoom/scroll) segera
            e.preventDefault();
        }
    }, []);

    const handleTwoFingerTouchMove = useCallback((e) => {
        if (e.touches.length === 2 && touchStartPosRef.current.length === 2) {
            const currentY0 = e.touches[0].clientY;
            const currentY1 = e.touches[1].clientY;

            const deltaY0 = currentY0 - touchStartPosRef.current[0].y;
            const deltaY1 = currentY1 - touchStartPosRef.current[1].y;

            // Deteksi swipe ke bawah untuk kedua jari
            if (deltaY0 > swipeThreshold && deltaY1 > swipeThreshold && !isSwipingRef.current) {
                isSwipingRef.current = true;
                setShowSettingsModal(true);
                e.preventDefault(); // Mencegah scrolling
            } else if (Math.abs(deltaY0) > swipeThreshold || Math.abs(deltaY1) > swipeThreshold) {
                // Jika ada pergerakan signifikan tapi bukan swipe 2 jari ke bawah
                isSwipingRef.current = true; // Tandai sebagai swiping untuk mencegah interaksi lain
                e.preventDefault(); // Tetap mencegah default action selama swipe
            }
        }
    }, [swipeThreshold]);

    const handleTwoFingerTouchEnd = useCallback(() => {
        touchStartPosRef.current = [];
        isSwipingRef.current = false;
    }, []);

    // Pasang Event Listeners
    useEffect(() => {
        // Listeners untuk Tap and Hold (Peek)
        document.body.addEventListener('touchstart', handleTapAndHoldStart, { passive: true }); // Passive true untuk performa
        document.body.addEventListener('touchend', handleTapAndHoldEnd);
        document.body.addEventListener('mousedown', handleTapAndHoldStart);
        document.body.addEventListener('mouseup', handleTapAndHoldEnd);

        // Listeners untuk Two-Finger Swipe (Settings)
        document.body.addEventListener('touchstart', handleTwoFingerTouchStart, { passive: false }); // PENTING: passive false
        document.body.addEventListener('touchmove', handleTwoFingerTouchMove, { passive: false }); // Passive false untuk preventDefault
        document.body.addEventListener('touchend', handleTwoFingerTouchEnd);


        return () => {
            document.body.removeEventListener('touchstart', handleTapAndHoldStart);
            document.body.removeEventListener('touchend', handleTapAndHoldEnd);
            document.body.removeEventListener('mousedown', handleTapAndHoldStart);
            document.body.removeEventListener('mouseup', handleTapAndHoldEnd);

            document.body.removeEventListener('touchstart', handleTwoFingerTouchStart);
            document.body.removeEventListener('touchmove', handleTwoFingerTouchMove);
            document.body.removeEventListener('touchend', handleTwoFingerTouchEnd);
        };
    }, [handleTapAndHoldStart, handleTapAndHoldEnd, handleTwoFingerTouchStart, handleTwoFingerTouchMove, handleTwoFingerTouchEnd]);

    // Tambahkan meta tag viewport dan PWA untuk mencegah zoom dan mengaktifkan mode fullscreen
    useEffect(() => {
        const createOrUpdateMeta = (name, content, rel = null) => {
            let tag = document.querySelector(`meta[name="${name}"]`) || document.querySelector(`link[rel="${rel}"]`);
            if (!tag) {
                tag = rel ? document.createElement('link') : document.createElement('meta');
                if (rel) tag.rel = rel;
                if (name) tag.name = name;
                document.head.appendChild(tag);
            }
            if (rel) { // For link tags like apple-touch-icon
                tag.href = content;
            } else { // For meta tags
                tag.content = content;
            }
            return tag;
        };

        // Viewport (anti-zoom)
        createOrUpdateMeta('viewport', 'width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0');

        // PWA Meta Tags (fullscreen, status bar, title)
        createOrUpdateMeta('apple-mobile-web-app-capable', 'yes');
        createOrUpdateMeta('apple-mobile-web-app-status-bar-style', 'black-translucent');
        createOrUpdateMeta('apple-mobile-web-app-title', 'Divina'); // Sesuaikan dengan nama aplikasi Anda

        // PWA Icon
        createOrUpdateMeta('apple-touch-icon', 'https://images2.imgbox.com/c4/02/as2b5MEJ_o.png', 'apple-touch-icon');
        createOrUpdateMeta('icon', 'https://images2.imgbox.com/c4/02/as2b5MEJ_o.png', 'icon');

        // Theme Color
        createOrUpdateMeta('theme-color', '#E1F5FE');

    }, []);


    // Tentukan kelas indikator koneksi
    const connectionIndicatorClass = isConnected
        ? (isTtsEnabled ? 'tts-active' : 'connected')
        : (showLoading ? 'loading' : 'failed');

    return (
        <div id="main-container" className="min-h-screen w-full flex flex-col justify-center items-center text-center p-5 overflow-hidden select-none"
             onClick={handleMainContainerClick}>
            <style>
                {`
                /* Original CSS from user.html */
                * { margin: 0; padding: 0; box-sizing: border-box; }
                html, body {
                    height: 100%; width: 100%; overflow: hidden; 
                    background: linear-gradient(to bottom, #FFFFFF 0%, #B3E5FC 100%);
                    user-select: none; -webkit-user-select: none;
                    /* Tambahan untuk mencegah zoom dan overscroll */
                    touch-action: none;
                    -ms-touch-action: none; /* For IE/Edge */
                    overscroll-behavior-y: contain;
                }
                body { /* Ini akan diterapkan ke div utama sebagai fallback */
                    display: flex; justify-content: center; align-items: center;
                    color: #5D4037; 
                    font-family: 'Cormorant Garamond', serif;
                    padding: 20px;
                }

                /* --- CONTAINER UTAMA --- */
                #main-container {
                    width: 100%; height: 100%;
                    padding: 20px;
                    display: flex; flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                    /* Tambahan untuk mencegah zoom dan overscroll */
                    touch-action: none;
                    -ms-touch-action: none; /* For IE/Edge */
                    overscroll-behavior-y: contain;
                }
                #main-container h1#title {
                    font-family: 'Cinzel', serif; 
                    font-size: clamp(2rem, 7vw, 3.5rem);
                    font-weight: 700;
                    color: #B8860B;
                    text-shadow: 1px 1px 3px rgba(255,255,255,0.5);
                    margin-bottom: 20px;
                    cursor: pointer;
                    transition: color 0.3s ease;
                    letter-spacing: 1px;
                }
                #main-container h1#title:hover { color: #A4770A; }
                
                /* --- KONTEN HASIL TAMPILAN (AI) --- */
                #result-display { display: none; }
                #result-display.visible { display: block; }
                #result-code {
                    font-family: 'Cinzel', serif; 
                    font-size: clamp(40px, 10vw, 80px);
                    color: #B8860B;
                    text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
                    margin: 0;
                    letter-spacing: 5px;
                }
                #ai-result {
                    font-family: 'Cormorant Garamond', serif;
                    font-style: italic;
                    font-size: clamp(20px, 4vw, 28px);
                    color: #5D4037;
                    margin-top: 20px;
                    max-width: 600px;
                    line-height: 1.6;
                }
                
                /* --- INDIKATOR KONEKSI --- */
                #connection-indicator {
                    position: fixed; top: 15px; left: 15px;
                    width: 8px; height: 8px; border-radius: 50%;
                    display: block; /* Selalu terlihat untuk menunjukkan status */
                    z-index: 150;
                    transition: all 0.3s ease;
                }
                #connection-indicator.failed, #connection-indicator.disconnected { 
                    background-color: #C62828; 
                    box-shadow: 0 0 10px #C62828;
                }
                #connection-indicator.connected { 
                    background-color: #2E7D32; 
                    box-shadow: 0 0 10px #2E7D32;
                }
                #connection-indicator.tts-active { 
                    background-color: #1565C0; 
                    box-shadow: 0 0 10px #1565C0;
                }
                #connection-indicator.tts-off {
                    background-color: #FFA000;
                    box-shadow: 0 0 10px #FFA000;
                }
                #connection-indicator.loading {
                    background-color: #64B5F6;
                    box-shadow: 0 0 10px #64B5F6;
                    animation: pulse 1.5s infinite;
                }

                /* --- OVERLAY UNTUK TAP-AND-HOLD (FIREBASE DATA) --- */
                .content-overlay { 
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    display: flex; /* Dikelola oleh React's conditional rendering */
                    justify-content: center;
                    align-items: center;
                    text-align: center;
                    background-color: rgba(225, 245, 254, 0.85);
                    backdrop-filter: blur(8px); z-index: 140;
                }
                #hold-content h2 {
                    font-family: 'Cinzel', serif;
                    font-size: clamp(24px, 6vw, 50px);
                    color: #795548;
                    margin: 0;
                    line-height: 1.4;
                }
                #hold-content p {
                    font-family: 'Cormorant Garamond', serif;
                    font-size: clamp(20px, 5vw, 36px);
                     color: #A1887F;
                }
                #hold-content #separator-line {
                    margin: 20px auto; width: 120px; height: 2px;
                    background-color: #D4AF37; border-radius: 2px;
                }

                /* --- KEYPAD INPUT --- */
                #numpad-overlay {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
                    display: flex; /* Dikelola oleh rendering kondisional React */
                    justify-content: center; align-items: center; z-index: 300;
                }
                #numpad-container { 
                    background: #fdfdfd; padding: 30px; border-radius: 20px; 
                    border: 1px solid #eee; text-align: center;
                }
                #numpad-prompt {
                    font-family: 'Cormorant Garamond', serif; font-size: 1.2rem;
                    color: #795548; margin-bottom: 25px;
                }
                .code-display { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
                .code-digit {
                    width: 50px; height: 65px; background-color: #eee;
                    border-bottom: 2px solid #ccc; border-radius: 8px;
                    display: flex; justify-content: center; align-items: center;
                    font-size: 2.5rem; font-family: 'Cormorant Garamond', serif; color: #4E342E;
                }
                .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
                .numpad-btn {
                    font-family: 'Lora', serif; font-size: 1.8rem; background-color: #fff;
                    border: 1px solid #ddd; color: #4E342E; border-radius: 50%;
                    width: 70px; height: 70px; margin: auto;
                    cursor: pointer; transition: all 0.2s ease;
                }
                .numpad-btn:hover { background-color: #f5f5f5; border-color: #ccc; }
                #btn-delete svg { width: 40%; height: 40%; fill: #8D6E63; pointer-events: none; }

                /* --- ANIMASI --- */
                #loading-overlay {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(225, 245, 254, 0.6); backdrop-filter: blur(5px);
                    display: flex; /* Dikelola oleh rendering kondisional React */
                    justify-content: center; align-items: center; z-index: 500;
                }
                .loader {
                    border: 8px solid #f3f3f3; border-top: 8px solid #B8860B;
                    border-radius: 50%; width: 60px; height: 60px;
                    animation: spin 1s linear infinite;
                }
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.7); } 100% { transform: scale(1); opacity: 1); } }
                
                /* Animasi baru untuk Toast */
                @keyframes fade-in-up {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                `}
            </style>

            <div id="connection-indicator" className={connectionIndicatorClass}></div>

            <h1 id="title" onClick={handleTitleClick}>
                Angel Number Interpreter
            </h1>

            <div id="result-display" className={resultCode ? 'visible' : ''}>
                <h1 id="result-code">
                    {resultCode}
                </h1>
                <p id="ai-result">
                    {aiResult}
                </p>
            </div>

            {showNumpad && (
                <Numpad
                    onCodeEntered={handleNumpadCodeEntered}
                    promptText={dynamicPrompts[Math.floor(Math.random() * dynamicPrompts.length)]}
                />
            )}

            {showLoading && (
                <div id="loading-overlay">
                    <div className="loader"></div>
                </div>
            )}

            {/* Overlay untuk Tap-and-Hold (Peek Information) */}
            {showHoldOverlay && firebaseData && (
                <div className="content-overlay" id="hold-overlay">
                    <div id="hold-content">
                        <h2 id="hold-bulan">{firebaseData.namaBulan}</h2>
                        <p id="hold-zodiak">{firebaseData.kemungkinanZodiak}</p>
                        <div id="separator-line"></div>
                        <h2 id="hold-pertanyaan">{firebaseData.pertanyaan}</h2>
                    </div>
                </div>
            )}

            <SettingsModal
                isVisible={showSettingsModal}
                onClose={() => setShowSettingsModal(false)}
                onSave={handleSaveSettings}
                initialChatId={telegramChatId}
                initialPeekMode={peekMode}
            />

            {toast && <Toast message={toast.message} type={toast.type} onClose={closeToast} />}
        </div>
    );
};

export default App;