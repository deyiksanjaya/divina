<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Divina - Layar Pesulap</title>

    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#E1F5FE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Divina">
    <link rel="apple-touch-icon" href="https://images2.imgbox.com/c4/02/as2b5MEJ_o.png">
    <link rel="icon" href="https://images2.imgbox.com/c4/02/as2b5MEJ_o.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* General Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%; width: 100%; overflow: hidden; 
            background: linear-gradient(to bottom, #FFFFFF 0%, #B3E5FC 100%);
            user-select: none; -webkit-user-select: none;
        }
        body {
            display: flex; justify-content: center; align-items: center;
            color: #5D4037; 
            font-family: 'Cormorant Garamond', serif;
            padding: 20px;
        }

        /* --- MAIN CONTAINER --- */
        #main-container {
            width: 100%; height: 100%;
            padding: 20px;
            display: flex; flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #app-main-title { /* Renamed from #title */
            font-family: 'Cinzel', serif; 
            font-size: clamp(2rem, 7vw, 3.5rem);
            font-weight: 700;
            color: #B8860B;
            text-shadow: 1px 1px 3px rgba(255,255,255,0.5);
            margin-bottom: 20px;
            letter-spacing: 1px;
            /* No cursor pointer by default, it will be added dynamically if connected */
        }
        #app-main-title.clickable {
            cursor: pointer;
            transition: color 0.3s ease;
        }
        #app-main-title.clickable:hover {
            color: #A4770A;
        }

        /* --- BUTTON CONTAINER --- */
        #button-container {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Space between buttons */
            margin-top: 20px;
            width: 80%; /* Adjust width as needed */
            max-width: 300px; /* Max width for buttons */
        }
        .main-action-btn {
            padding: 15px 25px;
            font-family: 'Cinzel', serif;
            font-size: clamp(1rem, 4vw, 1.5rem);
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            letter-spacing: 0.5px;
        }
        #start-btn {
            background-color: #B8860B;
            color: white;
        }
        #start-btn:hover {
            background-color: #A4770A;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        .secondary-btn {
            background-color: #F5F5DC; /* Creamy color */
            color: #5D4037;
            border: 1px solid #D4AF37;
        }
        .secondary-btn:hover {
            background-color: #EEE8AA; /* Lighter creamy color */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        
        /* --- AI RESULT DISPLAY --- */
        #result-display { display: none; }
        #result-display.visible { display: block; }
        #result-code {
            font-family: 'Cinzel', serif; 
            font-size: clamp(40px, 10vw, 80px);
            color: #B8860B;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
            margin: 0;
            letter-spacing: 5px;
        }
        #ai-result {
            font-family: 'Cormorant Garamond', serif;
            font-style: italic;
            font-size: clamp(20px, 4vw, 28px);
            color: #5D4037;
            margin-top: 20px;
            max-width: 600px;
            line-height: 1.6;
        }
        
        /* --- CONNECTION INDICATOR --- */
        #connection-indicator {
            position: fixed; top: 15px; left: 15px;
            width: 8px; height: 8px; border-radius: 50%;
            display: none; z-index: 150;
            transition: all 0.3s ease;
        }
        #connection-indicator.failed, #connection-indicator.disconnected { 
            background-color: #C62828; 
            box-shadow: 0 0 10px #C62828;
        }
        #connection-indicator.connected { 
            background-color: #2E7D32; 
            box-shadow: 0 0 10px #2E7D32;
        }
        #connection-indicator.tts-active { 
            background-color: #1565C0; 
            box-shadow: 0 0 10px #1565C0;
        }
        #connection-indicator.connected-tts-off { 
            background-color: #FFA000;
            box-shadow: 0 0 10px #FFA000;
        }
        #connection-indicator.loading {
            background-color: #64B5F6;
            box-shadow: 0 0 10px #64B5F6;
            animation: pulse 1.5s infinite;
        }

        /* --- TAP-AND-HOLD OVERLAY (FIREBASE DATA) --- */
        .content-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; 
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: rgba(225, 245, 254, 0.85);
            backdrop-filter: blur(8px); z-index: 140;
        }
        #hold-content h2 {
            font-family: 'Cinzel', serif;
            font-size: clamp(24px, 6vw, 50px);
            color: #795548;
            margin: 0;
            line-height: 1.4;
        }
        #hold-content p {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(20px, 5vw, 36px);
             color: #A1887F;
        }
        #hold-content #separator-line {
            margin: 20px auto; width: 120px; height: 2px;
            background-color: #D4AF37; border-radius: 2px;
        }

        /* --- KEYPAD INPUT --- */
        #numpad-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 300;
        }
        #numpad-container { 
            background: #fdfdfd; padding: 30px; border-radius: 20px; 
            border: 1px solid #eee; text-align: center;
        }
        #numpad-prompt {
            font-family: 'Cormorant Garamond', serif; font-size: 1.2rem;
            color: #795548; margin-bottom: 25px;
        }
        .code-display { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .code-digit {
            width: 50px; height: 65px; background-color: #eee;
            border-bottom: 2px solid #ccc; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; font-family: 'Cormorant Garamond', serif; color: #4E342E;
        }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .numpad-btn {
            font-family: 'Lora', serif; font-size: 1.8rem; background-color: #fff;
            border: 1px solid #ddd; color: #4E342E; border-radius: 50%;
            width: 70px; height: 70px; margin: auto;
            cursor: pointer; transition: all 0.2s ease;
        }
        .numpad-btn:hover { background-color: #f5f5f5; border-color: #ccc; }
        #btn-delete svg { width: 40%; height: 40%; fill: #8D6E63; pointer-events: none; }

        /* --- ANIMATIONS --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(225, 245, 254, 0.6); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 500;
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #B8860B;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        /* Settings Modal Styles */
        #settings-overlay {
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(8px);
            z-index: 400; 
        }
        #settings-container {
            background: #fdfdfd;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #eee;
            text-align: center;
            max-width: 400px;
            width: 90%; 
        }
        #settings-container h2 {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: #795548;
            margin-bottom: 25px;
        }
        .setting-item {
            margin-bottom: 20px;
            text-align: left;
        }
        .setting-item label {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            color: #5D4037;
            display: block;
            margin-bottom: 8px;
        }
        #telegram-chat-id {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            color: #4E342E;
        }
        .switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
        }
        /* The switch - the box around the slider */
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        /* The slider */
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
        }

        input:checked + .slider {
          background-color: #B8860B;
        }

        input:focus + .slider {
          box-shadow: 0 0 1px #B8860B;
        }

        input:checked + .slider:before {
          -webkit-transform: translateX(26px);
          -ms-transform: translateX(26px);
          transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
          border-radius: 34px;
        }

        .slider.round:before {
          border-radius: 50%;
        }

        .setting-actions {
            margin-top: 30px;
            display: flex;
            justify-content: space-around;
            gap: 15px;
        }
        .setting-actions button {
            padding: 10px 20px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #save-settings-btn {
            background-color: #B8860B;
            color: white;
        }
        #save-settings-btn:hover {
            background-color: #A4770A;
        }
        #close-settings-btn {
            background-color: #ccc;
            color: #5D4037;
        }
        #close-settings-btn:hover {
            background-color: #bbb;
        }

        /* Toast Message for Telegram */
        #toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            white-space: nowrap; 
        }
        #toast-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* NEW: Info Modal Styles */
        #info-modal-overlay {
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(8px);
            z-index: 450; /* Higher than settings, lower than loading */
        }
        #info-modal-container {
            background: #fdfdfd;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #eee;
            text-align: center;
            max-width: 500px;
            width: 90%; 
        }
        #info-modal-container h2 {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: #795548;
            margin-bottom: 20px;
        }
        #info-modal-container p {
            font-family: 'Cormorant Garamond', serif;
            font-size: clamp(1rem, 3.5vw, 1.2rem);
            color: #5D4037;
            line-height: 1.6;
            margin-bottom: 30px;
            text-align: justify; /* Justify text for better readability */
        }
        #info-modal-close-btn {
            padding: 10px 25px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            background-color: #B8860B;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            /* No hover effects */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 600px) {
            #numpad-container, #settings-container, #info-modal-container {
                padding: 20px;
            }
            .code-digit {
                width: 45px;
                height: 60px;
                font-size: 2rem;
            }
            .numpad-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            .setting-actions {
                flex-direction: column;
                gap: 10px;
            }
            .setting-actions button {
                width: 100%;
            }
            #button-container {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <h1 id="app-main-title">Angel Number Interpreter</h1>
        <div id="button-container">
            <button id="start-btn" class="main-action-btn">Mulai</button>
            <button id="what-is-angel-btn" class="main-action-btn secondary-btn">What is Angel Number</button>
            <button id="about-app-btn" class="main-action-btn secondary-btn">About This App</button>
        </div>
        <div id="result-display">
            <h1 id="result-code"></h1>
            <p id="ai-result"></p>
        </div>
    </div>

    <div id="connection-indicator"></div>
    <div id="loading-overlay"><div class="loader"></div></div>
    
    <div class="content-overlay" id="hold-overlay">
        <div id="hold-content">
            <h2 id="hold-bulan"></h2>
            <p id="hold-zodiak"></p>
            <div id="separator-line"></div>
            <h2 id="hold-pertanyaan"></h2>
        </div>
    </div>
    
    <div id="numpad-overlay">
        <div id="numpad-container">
            <h2 id="numpad-prompt"></h2>
            <div class="code-display">
                <span class="code-digit"></span><span class="code-digit"></span>
                <span class="code-digit"></span><span class="code-digit"></span>
            </div>
            <div class="numpad" id="main-numpad">
                <button class="numpad-btn" data-key="1">1</button><button class="numpad-btn" data-key="2">2</button><button class="numpad-btn" data-key="3">3</button>
                <button class="numpad-btn" data-key="4">4</button><button class="numpad-btn" data-key="5">5</button><button class="numpad-btn" data-key="6">6</button>
                <button class="numpad-btn" data-key="7">7</button><button class="numpad-btn" data-key="8">8</button><button class="numpad-btn" data-key="9">9</button>
                <button class="numpad-btn" id="btn-delete" data-key="del"><svg viewBox="0 0 576 512"><path d="M576 128c0-35.3-28.7-64-64-64H205.3c-17 0-33.3 6.7-45.3 18.7L9.4 233.4c-6 6-9.4 14.1-9.4 22.6s3.4 16.6 9.4 22.6L160 429.3c12 12 28.3 18.7 45.3 18.7H512c35.3 0 64-28.7 64-64V128zM271 175c9.4-9.4 24.6-9.4 33.9 0l47 47 47-47c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-47-47-47 47c-9.4 9.4-24.6-9.4-33.9 0s-9.4-24.6 0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6 0-33.9z"/></svg></button>
                <button class="numpad-btn" data-key="0">0</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal HTML -->
    <div id="settings-overlay" class="content-overlay">
        <div id="settings-container">
            <h2>Pengaturan</h2>
            <div class="setting-item">
                <label for="telegram-chat-id">ID Obrolan Telegram:</label>
                <input type="text" id="telegram-chat-id" placeholder="Masukkan ID Obrolan Anda">
            </div>
            <div class="setting-item switch-container">
                <span>Kirim ke Telegram</span>
                <label class="switch">
                    <input type="checkbox" id="send-to-telegram-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="setting-actions">
                <button id="save-settings-btn">Simpan</button>
                <button id="close-settings-btn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- NEW: Info Modal HTML -->
    <div id="info-modal-overlay" class="content-overlay">
        <div id="info-modal-container">
            <h2 id="info-modal-title"></h2>
            <p id="info-modal-content"></p>
            <button id="info-modal-close-btn">Tutup</button>
        </div>
    </div>

    <!-- Toast Message HTML -->
    <div id="toast-message"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js";

        // Firebase configuration (copied from index.html)
        const firebaseConfig = {
          apiKey: "AIzaSyCblBBI3macwNluj2Fv0QoHwHHuJKVtRec",
          authDomain: "divina-connect.firebaseapp.com",
          databaseURL: "https://divina-connect-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "divina-connect",
          storageBucket: "divina-connect.firebasestorage.app",
          messagingSenderId: "777570372540",
          appId: "1:777570372540:web:6b4f3be1b46dbe9fdcf9b9"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // --- DOM ELEMENTS ---
        const mainContainer = document.getElementById('main-container');
        const appMainTitle = document.getElementById('app-main-title'); // Renamed from 'title'
        const buttonContainer = document.getElementById('button-container'); // New element
        const startBtn = document.getElementById('start-btn'); // New button
        const whatIsAngelBtn = document.getElementById('what-is-angel-btn'); // New button
        const aboutAppBtn = document.getElementById('about-app-btn'); // New button
        const resultDisplay = document.getElementById('result-display');
        const connectionIndicator = document.getElementById('connection-indicator');
        const holdOverlay = document.getElementById('hold-overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const numpadOverlay = document.getElementById('numpad-overlay');
        const numpadPrompt = document.getElementById('numpad-prompt');
        const mainNumpad = document.getElementById('main-numpad');
        const codeDigitDisplays = document.querySelectorAll('.code-digit');
        const resultCodeDisplay = document.getElementById('result-code');
        const aiResultDisplay = document.getElementById('ai-result');
        const holdBulan = document.getElementById('hold-bulan');
        const holdZodiak = document.getElementById('hold-zodiak');
        const holdPertanyaan = document.getElementById('hold-pertanyaan');

        // Settings Modal DOM elements
        const settingsOverlay = document.getElementById('settings-overlay');
        const telegramChatIdInput = document.getElementById('telegram-chat-id');
        const sendToTelegramToggle = document.getElementById('send-to-telegram-toggle');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const toastMessage = document.getElementById('toast-message');

        // NEW: Info Modal DOM elements
        const infoModalOverlay = document.getElementById('info-modal-overlay');
        const infoModalTitle = document.getElementById('info-modal-title');
        const infoModalContent = document.getElementById('info-modal-content');
        const infoModalCloseBtn = document.getElementById('info-modal-close-btn');

        // --- STATE & DATA VARIABLES ---
        let enteredCode = "";
        let isConnected = false;
        let holdTimeout;
        let isTtsEnabled = false; 
        let firebaseData = null;
        let ttsTapCount = 0;
        let ttsTapTimer;
        const dynamicPrompts = [
            "masukan kombinasi angka random dalam hidupmu", "angka apa yang terlintas di benakmu saat ini?",
            "bisikan empat digit angka dari alam semesta...", "kombinasi mana yang memanggilmu hari ini?",
            "ungkap takdirmu melalui empat angka pilihan."
        ];

        // State for app settings (Telegram)
        let appSettings = {
            telegramChatId: '',
            sendToTelegram: false
        };

        // --- AI & FIREBASE FUNCTIONS ---
        
        function cleanAIResponse(responseText) {
            const targetPhrase = "kombinasi ini";
            const lowercasedResponse = responseText.toLowerCase();
            const startIndex = lowercasedResponse.indexOf(targetPhrase);

            if (startIndex !== -1) {
                return responseText.substring(startIndex);
            }
            return responseText;
        }

        async function generateBarnumStatement(code) {
            const prompt = `Hasilkan satu kalimat saja yang menjelaskan makna kombinasi angka ${code} dari olahan barnum statement. JANGAN gunakan kata pembuka seperti "Tentu" atau "Berikut". Kalimat HARUS dimulai dengan "kombinasi ini..." dan merujuk pada pembaca dengan kata "kamu".`;
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyAbmZ1Y64hK4QhIhrHyVdn5ycIk4C7I2io"; // Your Gemini API Key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return cleanAIResponse(result.candidates[0].content.parts[0].text);
            }
            throw new Error("Invalid AI response format.");
        }

        async function verifyAndConnect(code) {
            connectionIndicator.className = 'loading';
            connectionIndicator.style.display = 'block';
            buttonContainer.style.display = 'none'; // Hide buttons
            resultDisplay.classList.remove('visible'); // Ensure result is hidden initially

            const roomRef = ref(database, 'rooms/' + code);
            try {
                const snapshot = await get(roomRef);
                if (snapshot.exists() && snapshot.val().presence) {
                    isConnected = true;
                    loadingOverlay.style.display = 'flex';
                    const aiText = await generateBarnumStatement(code);
                    loadingOverlay.style.display = 'none';
                    
                    resultCodeDisplay.textContent = code;
                    aiResultDisplay.textContent = aiText;
                    resultDisplay.classList.add('visible');
                    
                    listenToFirebaseForTTS(code);
                    
                    // NEW: If Telegram sending is enabled, send the chat ID to Firebase
                    if (appSettings.sendToTelegram && appSettings.telegramChatId) {
                        const userTelegramRef = ref(database, 'rooms/' + code + '/userTelegramChatId');
                        await set(userTelegramRef, appSettings.telegramChatId);
                        showToast("ID Obrolan Telegram dikirim ke server.");
                    } 

                    // Set connection indicator based on TTS state
                    if (isTtsEnabled) {
                        connectionIndicator.className = 'tts-active';
                    } else {
                        connectionIndicator.className = 'connected';
                    }
                    // Make main title clickable to reload when connected
                    appMainTitle.classList.add('clickable');

                } else {
                    throw new Error(`Room ${code} tidak ditemukan atau tidak aktif.`);
                }
            } catch (error) {
                loadingOverlay.style.display = 'none';
                handleConnectionFailure(error.message);
            }
        }
        
        function listenToFirebaseForTTS(code) {
            const dataRef = ref(database, 'rooms/' + code + '/data');
            onValue(dataRef, (snapshot) => {
                if (snapshot.exists()) {
                    const { namaBulan, kemungkinanZodiak } = snapshot.val();
                    let pertanyaan = "";
                    switch (namaBulan) {
                        case "Januari":   pertanyaan = "Q"; break; case "Februari":  pertanyaan = "A"; break;
                        case "Maret":     pertanyaan = "R"; break; case "April":     pertanyaan = "E"; break;
                        case "Mei":       pertanyaan = "U"; break; case "Juni":      pertanyaan = "G"; break;
                        case "Juli":      pertanyaan = "L"; break; case "Agustus":   pertanyaan = "V"; break;
                        case "September": pertanyaan = "B"; break; case "Oktober":   pertanyaan = "O"; break;
                        case "November":  pertanyaan = "T"; break; case "Desember":  pertanyaan = "S"; break;
                    }
                    firebaseData = { namaBulan, kemungkinanZodiak, pertanyaan }; 

                    // Update hold content immediately
                    holdBulan.textContent = firebaseData.namaBulan;
                    holdZodiak.textContent = firebaseData.kemungkinanZodiak;
                    holdPertanyaan.textContent = firebaseData.pertanyaan;

                    if (isTtsEnabled) {
                        speak(`${namaBulan}. ${kemungkinanZodiak}. ${pertanyaan}.`);
                    }
                    // Telegram message sending is now handled by index.html
                }
            });
        }

        function handleConnectionFailure(errorMessage) {
            isConnected = false;
            connectionIndicator.className = 'failed'; 
            resultCodeDisplay.textContent = "Error";
            aiResultDisplay.textContent = errorMessage || "SERVER ERROR: Angka tidak aktif atau tidak ditemukan. Coba lagi.";
            resultDisplay.classList.add('visible');
            // Hide result and show buttons after a delay
            setTimeout(() => {
                resultDisplay.classList.remove('visible');
                buttonContainer.style.display = 'flex'; // Show buttons again
                appMainTitle.classList.remove('clickable'); // Remove clickable from title
            }, 3000);
        }

        // --- UI & INTERACTION FUNCTIONS ---
        function startHold(e) {
            if (e.target.closest('#numpad-overlay') || e.target.closest('#settings-overlay') || e.target.closest('#info-modal-overlay')) return; 
            if (isConnected && firebaseData) {
                holdTimeout = setTimeout(() => {
                    holdOverlay.style.display = 'flex';
                }, 500);
            }
        }

        function endHold() {
            clearTimeout(holdTimeout);
            holdOverlay.style.display = 'none';
        }

        function speak(text) {
            if (!text || !isTtsEnabled) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            window.speechSynthesis.speak(utterance);
        }
        
        function toggleTTS() {
            isTtsEnabled = !isTtsEnabled;
            connectionIndicator.classList.remove('connected', 'tts-active', 'connected-tts-off'); 

            if (isTtsEnabled) {
                connectionIndicator.classList.add('tts-active'); 
                speak("Suara diaktifkan");
                if (firebaseData) {
                    speak(`${firebaseData.namaBulan}. ${firebaseData.kemungkinanZodiak}. ${firebaseData.pertanyaan}.`);
                }
            } else {
                window.speechSynthesis.cancel();
                if (isConnected) {
                    connectionIndicator.classList.add('connected-tts-off'); 
                } else {
                    connectionIndicator.style.display = 'none'; 
                }
            }
        }
        
        function updateNumpadDisplay() {
            for (let i = 0; i < 4; i++) {
                codeDigitDisplays[i].textContent = enteredCode[i] || "";
            }
        }

        function showNumpad() {
            const randomIndex = Math.floor(Math.random() * dynamicPrompts.length);
            numpadPrompt.textContent = dynamicPrompts[randomIndex];
            enteredCode = "";
            updateNumpadDisplay();
            numpadOverlay.style.display = 'flex';
        }

        // SETTINGS FUNCTIONS (LOAD, SAVE, SHOW/HIDE MODAL, TOAST)
        function loadSettings() {
            try {
                const storedSettings = JSON.parse(localStorage.getItem('divinaSettings'));
                if (storedSettings) {
                    appSettings = { ...appSettings, ...storedSettings };
                    telegramChatIdInput.value = appSettings.telegramChatId;
                    sendToTelegramToggle.checked = appSettings.sendToTelegram;
                }
            } catch (e) {
                console.error("Gagal memuat pengaturan dari localStorage:", e);
            }
        }

        function saveSettings() {
            appSettings.telegramChatId = telegramChatIdInput.value.trim();
            appSettings.sendToTelegram = sendToTelegramToggle.checked;
            try {
                localStorage.setItem('divinaSettings', JSON.stringify(appSettings));
                showToast("Pengaturan disimpan!");
                // If settings are saved and connected, update Firebase with new chat ID if needed
                if (isConnected && enteredCode) {
                    const userTelegramRef = ref(database, 'rooms/' + enteredCode + '/userTelegramChatId');
                    if (appSettings.sendToTelegram && appSettings.telegramChatId) {
                        set(userTelegramRef, appSettings.telegramChatId);
                    } 
                }
            } catch (e) {
                console.error("Gagal menyimpan pengaturan ke localStorage:", e);
                showToast("Gagal menyimpan pengaturan.", true);
            }
            hideSettingsModal(); 
        }

        function showSettingsModal() {
            loadSettings(); 
            settingsOverlay.style.display = 'flex';
        }

        function hideSettingsModal() {
            settingsOverlay.style.display = 'none';
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toastMessage.style.backgroundColor = isError ? 'rgba(200, 0, 0, 0.8)' : 'rgba(0, 0, 0, 0.8)';
            toastMessage.classList.add('show');
            setTimeout(() => {
                toastMessage.classList.remove('show');
            }, 3000);
        }

        // NEW: Info Modal Functions
        function showInfoModal(title, content) {
            infoModalTitle.textContent = title;
            infoModalContent.textContent = content;
            infoModalOverlay.style.display = 'flex';
        }

        function hideInfoModal() {
            infoModalOverlay.style.display = 'none';
        }

        // --- EVENT LISTENERS ---
        document.body.addEventListener('mousedown', startHold);
        document.body.addEventListener('mouseup', endHold);
        document.body.addEventListener('touchstart', startHold, { passive: true });
        document.body.addEventListener('touchend', endHold);
        
        // New event listeners for the buttons
        startBtn.addEventListener('click', () => {
            showNumpad();
        });

        whatIsAngelBtn.addEventListener('click', () => {
            showInfoModal(
                "Apa Itu Angel Number?",
                "Angel Number adalah urutan angka berulang yang diyakini membawa pesan dari alam semesta, malaikat pelindung, atau panduan spiritual. Angka-angka ini sering muncul secara kebetulan dalam kehidupan sehari-hari, seperti pada jam, plat nomor, atau tanda terima, dan dianggap sebagai tanda atau konfirmasi dari dunia spiritual."
            );
        });

        aboutAppBtn.addEventListener('click', () => {
            showInfoModal(
                "Tentang Aplikasi Ini",
                "Aplikasi ini dirancang untuk membantu Anda mengungkap makna tersembunyi di balik kombinasi angka yang Anda rasakan. Cukup masukkan angka-angka tersebut, dan biarkan aplikasi ini membimbing Anda menuju pemahaman yang lebih dalam tentang pesan-pesan yang ada di sekitar Anda. Ini adalah alat untuk introspeksi dan penemuan diri."
            );
        });

        // Main title now only reloads if connected
        appMainTitle.addEventListener('click', () => {
            if (isConnected) { window.location.reload(); }
        });

        mainContainer.addEventListener('click', (e) => {
            // Only allow TTS toggle if connected and not clicking on numpad/settings/info modal/buttons
            if (!isConnected || e.target.closest('#numpad-overlay') || e.target.closest('#settings-overlay') || e.target.closest('#info-modal-overlay') || e.target.closest('#button-container')) return; 
            clearTimeout(ttsTapTimer);
            ttsTapCount++;
            ttsTapTimer = setTimeout(() => { ttsTapCount = 0; }, 600);
            if (ttsTapCount === 3) {
                ttsTapCount = 0;
                toggleTTS();
            }
        });

        mainNumpad.addEventListener('click', (e) => {
            if (!e.target.matches('.numpad-btn')) return;
            const key = e.target.dataset.key;
            if (key === 'del') { enteredCode = enteredCode.slice(0, -1); } 
            else if (enteredCode.length < 4) { enteredCode += key; }
            updateNumpadDisplay();
            if (enteredCode.length === 4) {
                numpadOverlay.style.display = 'none'; 
                verifyAndConnect(enteredCode); 
            }
        });
        
        // Close numpad if clicking outside it
        numpadOverlay.addEventListener('click', (e) => {
            if (e.target === numpadOverlay) { numpadOverlay.style.display = 'none'; }
        });

        // Event listeners for Settings Modal
        saveSettingsBtn.addEventListener('click', saveSettings);
        closeSettingsBtn.addEventListener('click', hideSettingsModal);
        // Close settings if clicking outside it
        settingsOverlay.addEventListener('click', (e) => {
            if (e.target === settingsOverlay) { hideSettingsModal(); }
        });

        // NEW: Event listener for Info Modal close button
        infoModalCloseBtn.addEventListener('click', hideInfoModal);
        // Close info modal if clicking outside it
        infoModalOverlay.addEventListener('click', (e) => {
            if (e.target === infoModalOverlay) { hideInfoModal(); }
        });

        // Gesture detection for two-finger swipe down
        let initialTouchY = {}; 
        let touchCount = 0;
        const SWIPE_THRESHOLD = 80; 

        document.body.addEventListener('touchstart', (e) => {
            if (numpadOverlay.style.display === 'flex' || settingsOverlay.style.display === 'flex' || infoModalOverlay.style.display === 'flex') {
                return;
            }

            touchCount = e.touches.length;
            if (touchCount >= 2) {
                initialTouchY = {
                    0: e.touches[0].clientY,
                    1: e.touches[1].clientY
                };
            }
        }, { passive: true }); 

        document.body.addEventListener('touchmove', (e) => {
            if (numpadOverlay.style.display === 'flex' || settingsOverlay.style.display === 'flex' || infoModalOverlay.style.display === 'flex') {
                return;
            }

            if (touchCount >= 2 && e.touches.length >= 2) {
                const currentTouchY0 = e.touches[0].clientY;
                const currentTouchY1 = e.touches[1].clientY;

                const deltaY0 = currentTouchY0 - initialTouchY[0];
                const deltaY1 = currentTouchY1 - initialTouchY[1];

                if (deltaY0 > SWIPE_THRESHOLD && deltaY1 > SWIPE_THRESHOLD && deltaY0 > 0 && deltaY1 > 0) {
                    showSettingsModal();
                    initialTouchY = {};
                    touchCount = 0;
                    e.preventDefault(); 
                }
            }
        }, { passive: false }); 

        document.body.addEventListener('touchend', (e) => {
            initialTouchY = {};
            touchCount = 0;
        });

        // Initial load of settings when DOM is ready
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html>